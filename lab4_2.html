<!DOCTYPE html>
<head>
	<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
	<title>D3</title>
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<style>

    .populacao, .demanda {
      stroke: #fff;
      stroke-width: 0.8px;
    }

	path:hover {
		fill-opacity: .7;
	}

    .hidden {
        display: none;
    }
    
    div.tooltip {
        color: #FFF;
        background-color: #808080;
        padding: .5em;
        border-radius: 2px;
        opacity: 0.8;
        position: absolute;
    }

	</style>
</head>
<body>
    <div class="container">
<div class="row">
<div class="col-sm-3">
    <h3>População Urbana Atendida com Abastecimento de Água</h3>
        <ul>
    <li> Valor da população urbana atendida com abastecimento de água pelo prestador de serviços, no último dia do ano de referência. Corresponde à população urbana que é efetivamente atendida com os serviços </li>
    <li><a id="municipioLi"></li>
    <li><a id="popAtendidaLi"></li>
        </ul>
        </div>
    <div class="col-sm-9">
	<div id="chart"></div>
    </div>
</div>
</div>
</body>
	<script src="js/d3.v4.min.js"></script>
	<script src="//d3js.org/d3-color.v1.min.js"></script>
	<script src="//d3js.org/d3-scale-chromatic.v1.min.js"></script>
 	 <script src="//d3js.org/topojson.v1.min.js"></script>
	<script>

    var myMap = new Map();
    	var tooltip = d3.select('body').append('div')
        .attr('class', 'hidden tooltip');
    width = 1300,
	height = 1000;
	var svg = d3.select("#chart")
			.append("svg")
			.attr('version', '1.1')
			.attr('viewBox', '0 210 '+width+' '+height)
			.attr('width', '100%')
			.attr('class', 'map-chart');

    var projection = d3.geoAlbers()
        .center([-36.820037, -7.195265])
        .rotate([0, 0])
        .parallels([0, 0])
        .scale(3900)
        .translate([width / 2, height / 2]);
    var path = d3.geoPath().projection(projection);
    var populacaoScale = d3.scaleThreshold();
    var demandaScale = d3.scaleLinear();
		d3.queue()
			.defer(d3.json, "data/municipios_sab.json")
			.defer(d3.csv, "data/info_agua.csv")
			.await(draw);
    function draw(error, pb, pop_urbana) {
      if (error) throw error;
			var municipios = topojson.feature(pb, pb.objects.municipios_sab);
			populacaoScale
       .domain([0, 5705, 12565, 78656, 999999999])
				.range([d3.rgb(254,240,217), d3.rgb(253,204,138), d3.rgb(252,141,89), d3.rgb(227,74,51), d3.rgb(179,0,0)]);
      svg.selectAll(".municipios")
        .data(municipios.features)
      .enter().append("path")
        .attr("id", function(d) {
         return "populacao-"+d.properties.ID; })
        .attr("d", path)
        .style("opacity", 0.5);
      svg.selectAll(".municipios")
        .data(municipios.features)
      .enter().append("path")
        .attr("id", function(d) { return "demanda-"+d.properties.ID })
        .attr("d", path)
                .on('mousemove', function(d) {
                    var mouse = d3.mouse(svg.node()).map(function(d) {
                        return parseInt(d);
                    });

                    var popUrbanaAtendida = myMap.get(d.properties.ID)[0];
                    if (popUrbanaAtendida == "NaN") {
                        popUrbanaAtendida = "Sem informações"
                    } else {
                        popUrbanaAtendida = popUrbanaAtendida + " habitantes atendidos.";
                    }
                    var municipioNome = myMap.get(d.properties.ID)[1];
                    document.getElementById("municipioLi").innerHTML = "Município: " + municipioNome;
                    document.getElementById("popAtendidaLi").innerHTML = "População Atendida: " + popUrbanaAtendida.replace(".0","");
                })
                .on('mouseout', function() {
                    tooltip.classed('hidden', true);
                })
        .style("opacity", 0.5);
			for (var i = 0; i < pop_urbana.length; i++) {
				myMap.set(parseInt(pop_urbana[i].GEOCODIGO), [pop_urbana[i].popUrbanaAtendida,
					String(pop_urbana[i].Município)]);
				svg.select("#populacao-"+pop_urbana[i].GEOCODIGO)
					.attr("fill", function (){  
                                    if (pop_urbana[i].popUrbanaAtendida == "NaN") return "#D3D3D3"; 
                                    return populacaoScale(+pop_urbana[i].popUrbanaAtendida)
                                  });
			}
    }

		</script>
</html>
